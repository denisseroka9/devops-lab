pipeline {
    agent none

    stages {
		stage('Build') {
			agent any

			steps {
				echo 'Build stage running on master agent'

				bat 'whoami'
				bat 'hostname'
				echo "Workspace path: ${WORKSPACE}"

				bat 'dir'

				stash name: 'workspace', includes: '**/*'
			}
		}


        stage('Unit Tests') {
			agent { label 'unit_windows' }

			steps {
				echo 'Unit tests stage'

				bat 'whoami'
				bat 'hostname'
				echo "Workspace: ${WORKSPACE}"

				unstash 'workspace'

				bat '''
				set PYTHONPATH=%WORKSPACE%
				C:\\Users\\denis\\AppData\\Local\\Programs\\Python\\Python314\\python.exe -m pytest test\\unit
				'''
			}
		}


        stage('Service Tests') {
			agent { label 'service_windows' }

			steps {
				echo 'Service tests stage'

				bat 'whoami'
				bat 'hostname'
				echo "Workspace: ${WORKSPACE}"

				unstash 'workspace'

				bat '''
				set FLASK_APP=app\\api.py
				start flask run
				start java -jar C:\\DevOps\\wiremock\\wiremock-jre8-standalone-2.28.0.jar --port 9090 --root-dir test\\wiremock
				set PYTHONPATH=%WORKSPACE%
				C:\\Users\\denis\\AppData\\Local\\Programs\\Python\\Python314\\python.exe -m pytest test\\rest
				'''
			}
		}

    }
}
